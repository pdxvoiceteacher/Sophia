name: plasticity-plumbing

on:
  workflow_dispatch:
  schedule:
    - cron: "17 9 * * *"  # daily at 09:17 UTC (edit or remove if desired)

jobs:
  plumbing:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup venv + install
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip
          .venv/bin/python -m pip install -e ./ucc[dev]
          .venv/bin/python -m pip install -e ./python[dev]
          .venv/bin/python -m pip install -e ./tools/coherenceledger_bootstrap
          .venv/bin/python -m pip install numpy fastapi httpx cryptography jsonschema pytest

      - name: Baseline run A (N=3)
        run: |
          rm -rf out/A_plumbing_ci
          for i in 01 02 03; do
            .venv/bin/python tools/telemetry/run_wrapper.py --out out/A_plumbing_ci/run_$i --quick --perturbations 1 --emit-tel --emit-tel-events
          done

      - name: Reflect & propose (forced min-psi for plumbing)
        run: |
          mkdir -p out/A_plumbing_ci/proposals
          OUT=$(.venv/bin/python tools/telemetry/reflect_and_propose.py --run-dir out/A_plumbing_ci/run_03 --out-proposals-dir out/A_plumbing_ci/proposals --proposal-id plumbing --created-at-utc 2026-01-01T00:00:00Z --min-psi 0.99)
          echo "PROPOSAL=$OUT" >> $GITHUB_ENV
          .venv/bin/python tools/telemetry/validate_tuning_proposal.py "$OUT"

      - name: Build median telemetry for A
        run: |
          .venv/bin/python - << 'PY'
          import json, glob, statistics
          from pathlib import Path
          root = Path("out/A_plumbing_ci")
          tele_paths = sorted(Path(p) for p in glob.glob(str(root / "run_*" / "telemetry.json")))
          assert tele_paths, "no A telemetry"
          runs = [json.loads(p.read_text(encoding="utf-8")) for p in tele_paths]
          for p, r in zip(tele_paths, runs):
            assert r["flags"]["telemetry_ok"] is True, f"telemetry_ok false: {p}"
          keys = ["E","T","Psi","Es","DeltaS","Lambda"]
          med = {k: statistics.median([r["metrics"][k] for r in runs]) for k in keys}
          base = runs[0]
          base["run_id"] = "A_plumbing_ci_median"
          base["created_at"] = "2026-01-01T00:00:00Z"
          for k,v in med.items(): base["metrics"][k] = float(v)
          outp = root / "telemetry_median.json"
          outp.write_text(json.dumps(base, sort_keys=True, indent=2) + "\n", encoding="utf-8")
          print("Wrote", outp)
          PY

      - name: Create worktree + apply proposal
        run: |
          rm -rf out/candidate_worktree_plumbing
          rm -rf out/B_plumbing_ci
          mkdir -p out/B_plumbing_ci
          git worktree add out/candidate_worktree_plumbing -b plasticity_candidate_plumbing
          .venv/bin/python tools/telemetry/apply_tuning_proposal.py --proposal "$PROPOSAL" --workdir out/candidate_worktree_plumbing --out-manifest out/B_plumbing_ci/applied_manifest.json

      - name: Candidate run B (N=3, in worktree)
        run: |
          for i in 01 02 03; do
            (cd out/candidate_worktree_plumbing && ../../.venv/bin/python tools/telemetry/run_wrapper.py --out ../B_plumbing_ci/run_$i --quick --perturbations 1 --emit-tel --emit-tel-events)
          done

      - name: Build median telemetry for B
        run: |
          .venv/bin/python - << 'PY'
          import json, glob, statistics
          from pathlib import Path
          root = Path("out/B_plumbing_ci")
          tele_paths = sorted(Path(p) for p in glob.glob(str(root / "run_*" / "telemetry.json")))
          assert tele_paths, "no B telemetry"
          runs = [json.loads(p.read_text(encoding="utf-8")) for p in tele_paths]
          for p, r in zip(tele_paths, runs):
            assert r["flags"]["telemetry_ok"] is True, f"telemetry_ok false: {p}"
          keys = ["E","T","Psi","Es","DeltaS","Lambda"]
          med = {k: statistics.median([r["metrics"][k] for r in runs]) for k in keys}
          base = runs[0]
          base["run_id"] = "B_plumbing_ci_median"
          base["created_at"] = "2026-01-01T00:00:00Z"
          for k,v in med.items(): base["metrics"][k] = float(v)
          outp = root / "telemetry_median.json"
          outp.write_text(json.dumps(base, sort_keys=True, indent=2) + "\n", encoding="utf-8")
          print("Wrote", outp)
          PY

      - name: v2.4 Median gate (plumbing)
        run: |
          .venv/bin/python tools/telemetry/compare_runs.py out/A_plumbing_ci/telemetry_median.json out/B_plumbing_ci/telemetry_median.json \
            --keys Psi,E,T,Es,DeltaS,Lambda \
            --nondecreasing Psi,E,T,Es \
            --nonincreasing Lambda,DeltaS \
            --eps 1e-4

      - name: Debug list A run_03 outputs
        if: always()
        run: |
          echo '=== ls -R out/A_plumbing_ci/run_03 ==='
          ls -R out/A_plumbing_ci/run_03 || true
          echo '=== telemetry.json artifacts ==='
          cat out/A_plumbing_ci/run_03/telemetry.json | python -c "import json,sys; d=json.load(sys.stdin); print(json.dumps(d.get('artifacts',[]), indent=2))"
      - name: Verify artifacts (A representative run)
        run: |
          .venv/bin/python tools/telemetry/verify_artifacts.py out/A_plumbing_ci/run_03/telemetry.json --repo-root .

      - name: Verify artifacts (B representative run)
        run: |
          .venv/bin/python tools/telemetry/verify_artifacts.py out/B_plumbing_ci/run_03/telemetry.json --repo-root .
      - name: Validate TEL JSONL
        if: always()
        run: |
          # Representative runs:
          # - accept: out/A_v24_ci/run_05 and out/B_v24_ci/run_05
          # - plumbing: out/A_plumbing_ci/run_03 and out/B_plumbing_ci/run_03
          for d in out/A_v24_ci/run_05 out/B_v24_ci/run_05 out/A_plumbing_ci/run_03 out/B_plumbing_ci/run_03; do
            if [ -f "$d/tel_events.jsonl" ]; then
              .venv/bin/python tools/telemetry/validate_jsonl.py "$d/tel_events.jsonl" --require-keys event,name,ts,run_id
            fi
            if [ -f "$d/ucc_tel_events.jsonl" ]; then
              .venv/bin/python tools/telemetry/validate_jsonl.py "$d/ucc_tel_events.jsonl"
            fi
          done


      - name: Cleanup worktree
        if: always()
        run: |
          git worktree remove out/candidate_worktree_plumbing --force || true
          git branch -D plasticity_candidate_plumbing || true

      - name: Upload plumbing artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plasticity_plumbing_out
          path: |
            out/A_plumbing_ci/telemetry_median.json
            out/B_plumbing_ci/telemetry_median.json
            out/B_plumbing_ci/applied_manifest.json
            out/A_plumbing_ci/run_03/tel_events.jsonl
            out/A_plumbing_ci/run_03/ucc_tel_events.jsonl
            out/B_plumbing_ci/run_03/tel_events.jsonl
            out/B_plumbing_ci/run_03/ucc_tel_events.jsonl
          if-no-files-found: ignore


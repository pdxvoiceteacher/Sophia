import re
from pathlib import Path

p = Path("tools/telemetry/run_wrapper.py")
txt = p.read_text(encoding="utf-8").replace("\r\n", "\n").replace("\r", "\n")

# Locate TEL post-run block between markers
pat = re.compile(r"(?s)^(\s*)# --- TEL post-run emission ---.*?^(\s*)# --- /TEL post-run emission ---\s*$", re.M)
m = pat.search(txt)
if not m:
    raise SystemExit("Could not find TEL post-run emission markers in run_wrapper.py")

indent = m.group(1)
i1 = indent + "    "
i2 = i1 + "    "
i3 = i2 + "    "
i4 = i3 + "    "

lines = []
lines.append(indent + "# --- TEL post-run emission ---")
lines.append(indent + 'if globals().get("_TEL_EMIT", False):')
lines.append(i1 + "def _tel_out_dir(argv):")
lines.append(i2 + "# supports: --out PATH  or  --out=PATH")
lines.append(i2 + "for i, a in enumerate(argv):")
lines.append(i3 + 'if a == "--out" and i + 1 < len(argv):')
lines.append(i4 + "return argv[i + 1]")
lines.append(i3 + 'if a.startswith("--out="):')
lines.append(i4 + 'return a.split("=", 1)[1]')
lines.append(i2 + "return None")
lines.append("")
lines.append(i1 + "try:")
lines.append(i2 + "from pathlib import Path")
lines.append(i2 + "import json as _json")
lines.append(i2 + "from konomi.tel import TelGraph")
lines.append(i2 + "from konomi.tel.recorder import TelRecorder")
lines.append("")
lines.append(i2 + "_out = _tel_out_dir(sys.argv)")
lines.append(i2 + "if not _out:")
lines.append(i3 + 'raise RuntimeError("TEL requested but --out was not found in argv")')
lines.append("")
lines.append(i2 + "_out_dir = Path(_out)")
lines.append(i2 + '_telemetry_path = _out_dir / "telemetry.json"')
lines.append(i2 + "if not _telemetry_path.exists():")
lines.append(i3 + 'raise FileNotFoundError(f"telemetry.json not found at {_telemetry_path}")')
lines.append("")
lines.append(i2 + '_telemetry_data = _json.loads(_telemetry_path.read_text(encoding="utf-8"))')
lines.append("")
lines.append(i2 + '# Build TEL graph with explicit checkpoints (deterministic ordering)')
lines.append(i2 + '_tel = TelGraph(graph_id="tel_run_wrapper", meta={"source": "run_wrapper.py"})')
lines.append(i2 + "_rec = TelRecorder(_tel)")
lines.append("")
lines.append(i2 + '_rec.checkpoint("run:telemetry_loaded", meta={"telemetry_path": str(_telemetry_path)})')
lines.append("")
lines.append(i2 + "# Step checkpoints: stage dirs in out/ (sorted)")
lines.append(i2 + "stage_dirs = []")
lines.append(i2 + "for sp in sorted(_out_dir.iterdir(), key=lambda x: x.name):")
lines.append(i3 + "if not sp.is_dir():")
lines.append(i4 + "continue")
lines.append(i3 + "name = sp.name")
lines.append(i3 + 'if name.startswith("konomi_smoke_") or name.startswith("ucc_cov_"):')
lines.append(i4 + "stage_dirs.append(sp)")
lines.append("")
lines.append(i2 + "for stage in stage_dirs:")
lines.append(i3 + 'cp = _rec.checkpoint(f"step:{stage.name}", meta={"dir": stage.name})')
lines.append(i3 + "# Attach key artifacts (sorted for determinism)")
lines.append(i3 + 'for f in sorted(stage.rglob("*_summary.json"), key=lambda x: x.as_posix()):')
lines.append(i4 + '_rec.attach_file(cp, f, root=_out_dir, kind="summary_json")')
lines.append(i3 + 'for f in sorted(stage.rglob("audit_bundle.json"), key=lambda x: x.as_posix()):')
lines.append(i4 + '_rec.attach_file(cp, f, root=_out_dir, kind="audit_bundle")')
lines.append("")
lines.append(i2 + "# Shallow telemetry tree for connectivity")
lines.append(i2 + '_tel.ingest_json_tree(_telemetry_data, root_id="telemetry", max_depth=2)')
lines.append(i2 + '_rec.checkpoint("run:tel_built")')
lines.append("")
lines.append(i2 + "# Persist full TEL graph")
lines.append(i2 + '_tel.write_json(_out_dir / "tel.json")')
lines.append("")
lines.append(i2 + "# Embed lean summary into telemetry.json")
lines.append(i2 + '_telemetry_data["tel_summary"] = _tel.summary()')
lines.append(i2 + '(_out_dir / "telemetry.json").write_text(')
lines.append(i3 + '_json.dumps(_telemetry_data, ensure_ascii=False, sort_keys=True, indent=2) + "\\n",')
lines.append(i3 + 'encoding="utf-8",')
lines.append(i3 + 'newline="\\n",')
lines.append(i2 + ")")
lines.append(i2 + 'print("[tel] updated telemetry.json with tel_summary")')
lines.append(i2 + 'print(f"[tel] wrote: {_out_dir / \"tel.json\"}")')
lines.append("")
lines.append(i1 + "except Exception as _e:")
lines.append(i2 + 'print(f"[tel] failed: {_e}", file=sys.stderr)')
lines.append(i2 + "raise")
lines.append(indent + "# --- /TEL post-run emission ---")

block = "\n".join(lines)
txt2 = pat.sub(block, txt)
p.write_text(txt2, encoding="utf-8", newline="\n")
print("OK: repaired TEL block")
